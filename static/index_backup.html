<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw Distribution</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="?v=2" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        html {
            scroll-behavior: smooth;
            margin: 0 !important;
            padding: 0 !important;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: rgb(247, 248, 254);
            margin: 0 !important;
            padding: 0 !important;
            min-height: 100vh;
            overflow-x: hidden;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            min-height: 100vh;
            overflow-y: auto;
        }

        .navbar {
            background: #ffffff !important;
            border-bottom: 1px solid #e2e8f0 !important;
            padding: 0 !important;
            margin: 0 !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
            width: 100vw !important;
            height: 60px !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            overflow: visible !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 999999 !important;
            transform: translate3d(0, 0, 0) !important;
            will-change: transform !important;
            contain: layout style paint !important;
            isolation: isolate !important;
        }
        
        /* Принудительное отображение хедера - максимальный приоритет */
        nav.navbar, .navbar, body > nav.navbar, html > body > nav.navbar {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100vw !important;
            height: 60px !important;
            background: #ffffff !important;
            border-bottom: 1px solid #e2e8f0 !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
            z-index: 999999 !important;
            margin: 0 !important;
            padding: 0 !important;
            transform: translate3d(0, 0, 0) !important;
            contain: layout style paint !important;
            isolation: isolate !important;
        }
        
        /* Принудительное отображение хедера */
        nav.navbar {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            height: 60px !important;
            background: #ffffff !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 999999 !important;
            margin: 0 !important;
            padding: 0 !important;
            transform: translate3d(0, 0, 0) !important;
            contain: layout style paint !important;
            isolation: isolate !important;
        }
        
        /* Принудительное позиционирование в самом верху */
        body > nav.navbar {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 999999 !important;
            transform: translate3d(0, 0, 0) !important;
            contain: layout style paint !important;
            isolation: isolate !important;
        }
        
        /* Жесткая фиксация для всех возможных случаев */
        html > body > nav.navbar {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 999999 !important;
            transform: translate3d(0, 0, 0) !important;
            contain: layout style paint !important;
            isolation: isolate !important;
        }

        .navbar .container {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 0 30px !important;
            height: 100% !important;
            position: relative !important;
            z-index: 1001 !important;
            width: 100% !important;
            max-width: 1200px !important;
            margin: 0 auto !important;
            visibility: visible !important;
            opacity: 1 !important;
            box-sizing: border-box !important;
            flex-wrap: nowrap !important;
        }

        .nav-brand {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            flex-shrink: 0 !important;
        }
        
        .nav-brand h1 {
            color: #000000 !important;
            font-size: 1.5rem !important;
            font-weight: 700 !important;
            margin: 0 !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
            height: auto !important;
        }

        .nav-links {
            display: flex !important;
            gap: 8px !important;
            flex-shrink: 0 !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .nav-link {
            color: #64748b !important;
            text-decoration: none !important;
            font-weight: 600 !important;
            padding: 8px 16px !important;
            border-radius: 25px !important;
            transition: all 0.3s ease !important;
            font-size: 0.9rem !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
            position: relative !important;
            overflow: hidden !important;
            visibility: visible !important;
            opacity: 1 !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav-link:hover::before {
            left: 100%;
        }

        .nav-link:hover {
            color: #1e40af;
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }

        .nav-link.active {
            color: #1e40af;
            background: #eff6ff;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }


        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-card:nth-child(1) {
            background: linear-gradient(135deg, #fff7ed, #fed7aa);
            border-left: 4px solid #ea580c;
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #fff7ed, #fed7aa);
            border-left: 4px solid #ea580c;
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            border-left: 4px solid #2563eb;
        }

        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, #f0fdf4, #bbf7d0);
            border-left: 4px solid #16a34a;
        }

        .stat-card:nth-child(5) {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-left: 4px solid #f59e0b;
        }

        .stat-card:nth-child(6) {
            background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
            border-left: 4px solid #8b5cf6;
        }

        .stat-card h3 {
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e40af;
            margin: 0;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 30px;
            min-height: 400px;
        }

        .panel {
            background: #ffffff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        #stats {
            height: auto;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .panel#requests-panel {
            max-height: 700px;
            overflow: hidden;
        }

        .panel#executors-panel {
            min-height: 200px;
            max-height: none;
            overflow: visible;
        }

        #requests-list {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #requests-list::-webkit-scrollbar {
            width: 4px;
        }

        #requests-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 2px;
        }

        #requests-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        #requests-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        #executors-list {
            max-height: none;
            overflow: visible;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .panel h2 {
            color: #1e40af;
            margin-bottom: 20px;
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }


        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.05s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            min-width: 160px;
            width: 160px;
            justify-content: center;
            height: 40px;
            box-sizing: border-box;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            box-shadow: 0 2px 4px rgba(107, 114, 128, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.4);
        }

        /* Анимации для уведомлений */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }


        /* Стили для диаграммы */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 25px;
        }

        .chart-section {
            background: #ffffff;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.08s ease;
            min-height: 280px;
            display: flex;
            flex-direction: column;
        }

        .chart-section:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .chart-section h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            text-align: center;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 6px;
        }

        /* Все панели теперь имеют одинаковую высоту */

        .chart-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 20px;
            gap: 12px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            margin: 0;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
            min-height: 250px;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .progress-chart {
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            margin: 0;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .progress-chart::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .workload-chart {
            height: 200px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding: 20px;
            gap: 6px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            margin: 0;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .workload-chart::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
        }

        .performance-analysis-chart {
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            margin: 0;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .performance-analysis-chart::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
        }

        .chart-bar {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            position: relative;
            transition: all 0.08s ease;
            cursor: pointer;
            height: 100%;
        }

        .chart-bar:hover {
            transform: translateY(-3px);
        }

        .chart-bar-column {
            width: 100%;
            background: #1e40af;
            border-radius: 8px 8px 0 0;
            transition: all 0.08s ease;
            position: relative;
            min-height: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-bar:hover .chart-bar-column {
            background: #1d4ed8;
            box-shadow: 0 6px 20px rgba(30, 64, 175, 0.4);
            transform: scale(1.05);
        }

        .chart-bar-label {
            margin-top: 8px;
            font-size: 0.85em;
            color: #4a5568;
            font-weight: 600;
            text-align: center;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chart-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 700;
            color: #2d3748;
            background: rgba(255, 255, 255, 0.9);
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .executor-item, .request-item {
            padding: 12px;
            margin-bottom: 0;
            border-radius: 8px;
            border-left: 4px solid #1e40af;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            min-height: 80px;
        }
        
        .request-item {
            padding: 10px;
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .executor-item:hover, .request-item:hover {
            background: #f8fafc;
            border-left-color: #1d4ed8;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .request-item.pending {
            border-left-color: #d97706;
            background: #fffbeb;
        }

        .request-item.assigned {
            border-left-color: #0891b2;
            background: #f0f9ff;
        }

        .request-item.completed {
            border-left-color: #059669;
            background: #f0fdf4;
        }

        /* Чередующиеся светлые синие оттенки для статусов */
        .request-item:nth-child(odd).pending {
            background: linear-gradient(135deg, #f0f4ff, #e0f2fe);
            border-left-color: #3b82f6;
        }

        .request-item:nth-child(even).pending {
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            border-left-color: #2563eb;
        }

        .request-item:nth-child(odd).assigned {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-left-color: #0ea5e9;
        }

        .request-item:nth-child(even).assigned {
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            border-left-color: #0891b2;
        }

        .request-item:nth-child(odd).completed {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-left-color: #10b981;
        }

        .request-item:nth-child(even).completed {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border-left-color: #059669;
        }

        /* Улучшенные стили для статусов */
        .request-item .status-text {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .request-item.pending .status-text {
            background: rgba(245, 158, 11, 0.1);
            color: #92400e;
        }

        .request-item.assigned .status-text {
            background: rgba(14, 165, 233, 0.1);
            color: #0c4a6e;
        }

        .request-item.completed .status-text {
            background: rgba(16, 185, 129, 0.1);
            color: #064e3b;
        }

        /* Чередующиеся синие оттенки для строк таблицы */
        .report-table tr:nth-child(odd) {
            background: linear-gradient(135deg, #f0f4ff, #e0f2fe);
        }

        .report-table tr:nth-child(even) {
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
        }

        .report-table tr:hover {
            background: linear-gradient(135deg, #bae6fd, #7dd3fc);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        /* Стили для чередующихся строк */
        .report-table .odd-row {
            background: linear-gradient(135deg, #f0f4ff, #e0f2fe) !important;
        }

        .report-table .even-row {
            background: linear-gradient(135deg, #e0f2fe, #bae6fd) !important;
        }

        .report-table .odd-row:hover,
        .report-table .even-row:hover {
            background: linear-gradient(135deg, #bae6fd, #7dd3fc) !important;
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .request-item.new {
            animation: pulse 1s;
        }

        @keyframes pulse {
            0% { 
                background: #fef3c7;
                transform: scale(1.02);
            }
            100% { 
                background: #ffffff;
                transform: scale(1);
            }
        }

        .flow-box {
            width: 100px;
            height: 100px;
            margin: 10px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
            position: relative;
        }

        .flow-box:hover {
            transform: scale(1.1);
        }

        .flow-box.pending {
            background: #2196F3;
            border: 3px solid #1976D2;
        }

        .flow-box.executor {
            background: #333;
            border: 3px solid #111;
            color: white;
        }

        .flow-box.assigned {
            background: #4CAF50;
            border: 3px solid #388E3C;
        }

        .flow-request {
            width: 60px;
            height: 30px;
            background: #2196F3;
            margin: 2px;
            border-radius: 5px;
            font-size: 10px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            margin: 4px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.05s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #1e40af;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-warning {
            background: #d97706;
            color: white;
        }

        .btn-warning:hover {
            background: #b45309;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            border: 1px solid #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
            border-color: #991b1b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.12s;
        }

        .error-percent {
            color: #dc3545;
            font-weight: bold;
        }

        .good-percent {
            color: #28a745;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: #ffffff;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            position: relative;
            border: 1px solid #e2e8f0;
        }
        
        .modal-close {
            position: absolute;
            right: 16px;
            top: 16px;
            font-size: 24px;
            font-weight: bold;
            color: #64748b;
            cursor: pointer;
            transition: color 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        
        .modal-close:hover {
            color: #dc2626;
            background: #fef2f2;
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: #1e40af;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.05s ease;
            background: #ffffff;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }
        
        .modal-content input:focus, .modal-content select:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }
        
        .modal-content label {
            display: block;
            margin-bottom: 6px;
            color: #374151;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .modal-content .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .modal-content .btn-group button {
            flex: 1;
        }

        .parameter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .param-name, .param-value {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .remove-param {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-param:hover {
            background: #c82333;
        }

        .add-param-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .add-param-btn:hover {
            background: #218838;
        }

        .modal-body {
            margin: 20px 0;
        }

        .modal-body p {
            margin: 10px 0;
            line-height: 1.5;
        }

        /* Анимация для модального окна удаления */
        #delete-modal .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .warning-block {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 10px;
            text-align: center;
            background: #fef2f2;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
        }

        /* Выпадающее меню */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            position: relative;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dropdown-toggle::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid currentColor;
            transition: transform 0.2s ease;
        }

        .dropdown-toggle:hover::after {
            transform: translateY(1px);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 150px;
            margin-top: 4px;
        }

        .dropdown-menu a {
            display: block;
            padding: 10px 16px;
            color: #374151;
            text-decoration: none;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s ease;
        }

        .dropdown-menu a:last-child {
            border-bottom: none;
        }

        .dropdown-menu a:hover {
            background-color: #f8fafc;
            color: #1e40af;
        }

        .dropdown-menu.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .request-item.moving {
            animation: approvalProcess 0.1s ease-in-out forwards;
            position: relative;
            overflow: hidden;
        }

        @keyframes approvalProcess {
            0% {
                opacity: 1;
                transform: scale(1);
                background: linear-gradient(135deg, #e3f2fd, #bbdefb);
                border-left: 4px solid #2196f3;
            }
            15% {
                opacity: 0.95;
                transform: scale(1.02);
                background: linear-gradient(135deg, #fff3e0, #ffcc80);
                border-left: 4px solid #ff9800;
                box-shadow: 0 4px 15px rgba(255, 152, 0, 0.2);
            }
            30% {
                opacity: 0.9;
                transform: scale(1.05);
                background: linear-gradient(135deg, #f3e5f5, #ce93d8);
                border-left: 4px solid #9c27b0;
                box-shadow: 0 6px 20px rgba(156, 39, 176, 0.2);
            }
            45% {
                opacity: 0.85;
                transform: scale(1.08);
                background: linear-gradient(135deg, #e0f2f1, #80cbc4);
                border-left: 4px solid #009688;
                box-shadow: 0 8px 25px rgba(0, 150, 136, 0.2);
            }
            60% {
                opacity: 0.9;
                transform: scale(1.05);
                background: linear-gradient(135deg, #e8f5e8, #a5d6a7);
                border-left: 4px solid #4caf50;
                box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
            }
            80% {
                opacity: 0.95;
                transform: scale(1.02);
                background: linear-gradient(135deg, #e8f5e8, #4caf50);
                border-left: 4px solid #2e7d32;
                box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4);
            }
            100% {
                opacity: 0;
                transform: scale(0.8);
                background: linear-gradient(135deg, #e8f5e8, #2e7d32);
                border-left: 4px solid #1b5e20;
                box-shadow: 0 2px 10px rgba(27, 94, 32, 0.5);
                height: 0;
                margin: 0;
                padding: 0;
            }
        }

        .request-item.moving::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: shimmer 0.05s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Дополнительные стили для улучшения дизайна */
        .controls {
            background: #ffffff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
        }

        .controls h3 {
            color: #1e40af;
            margin-bottom: 20px;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 16px 0;
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #1e40af;
        }

        .checkbox-container label {
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            font-size: 0.875rem;
        }


        /* Анимация загрузки */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Улучшенные скроллбары */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
        }

        
        /* Стили для больших экранов - кнопки всегда видны */
        .nav-links {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .nav-brand {
            flex-shrink: 0;
        }

        /* Адаптивность для разных масштабов */
        @media (max-width: 1200px) {
            .navbar .container {
                padding: 0 20px !important;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }
            
            .navbar .container {
                flex-direction: column;
                gap: 16px;
                padding: 10px 20px;
            }
            
            .nav-links {
                gap: 16px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .content-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .panel#executors-panel {
                min-height: 150px;
            }
            
            .executor-item {
                min-height: 70px;
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .nav-brand h1 {
                font-size: 1.1rem;
            }
            
            .panel {
                padding: 20px;
            }
            
            .controls {
                padding: 20px;
            }
            
            .controls .grid-2-columns {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        /* Фиксация для всех масштабов - убираем ограничения */
        @media (min-resolution: 0.5dppx) {
            .navbar {
                transform: translate3d(0, 0, 0) !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 99999 !important;
                width: 100vw !important;
                height: 60px !important;
            }
        }
        
        @media (min-resolution: 1dppx) {
            .navbar {
                transform: translate3d(0, 0, 0) !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 99999 !important;
                width: 100vw !important;
                height: 60px !important;
            }
        }
        
        @media (min-resolution: 1.5dppx) {
            .navbar {
                transform: translate3d(0, 0, 0) !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 99999 !important;
                width: 100vw !important;
                height: 60px !important;
            }
        }
        
        @media (min-resolution: 2dppx) {
            .navbar {
                transform: translate3d(0, 0, 0) !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 99999 !important;
                width: 100vw !important;
                height: 60px !important;
            }
        }
        
        @media (min-resolution: 3dppx) {
            .navbar {
                transform: translate3d(0, 0, 0) !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 99999 !important;
                width: 100vw !important;
                height: 60px !important;
            }
        }
        
        /* Максимальная жесткость для всех случаев */
        * {
            box-sizing: border-box !important;
        }
        
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden !important;
        }
        
        /* Принудительная фиксация хедера */
        .navbar, nav.navbar, body > nav.navbar, html > body > nav.navbar {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 999999 !important;
            transform: translate3d(0, 0, 0) !important;
            contain: layout style paint !important;
            isolation: isolate !important;
            width: 100vw !important;
            height: 60px !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Принудительное отображение кнопок навигации */
        .nav-links, .navbar .nav-links, nav.navbar .nav-links {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1000001 !important;
            flex-shrink: 0 !important;
            width: auto !important;
            height: auto !important;
        }
        
        .nav-link, .navbar .nav-link, nav.navbar .nav-link {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1000002 !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
            width: auto !important;
            height: auto !important;
        }
        
        /* Стили для уведомлений */
        .notification {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 12px 16px;
            margin: 5px auto;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: auto;
            animation: slideDown 0.3s ease-out;
            position: relative;
            z-index: 1000004;
        }
        
        .notification.success {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        }
        
        .notification.error {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
        }
        
        .notification.info {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
        }
        
        .notification-icon {
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 16px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .notification-close:hover {
            background-color: #f3f4f6;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(-100%);
                opacity: 0;
            }
        }
        
        /* Максимальный приоритет для хедера */
        * {
            box-sizing: border-box !important;
        }
        
        .navbar, nav.navbar {
            z-index: 999999 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100vw !important;
            height: 60px !important;
            background: #ffffff !important;
            border-bottom: 1px solid #e2e8f0 !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
            margin: 0 !important;
            padding: 0 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            transform: translate3d(0, 0, 0) !important;
            contain: layout style paint !important;
            isolation: isolate !important;
        }
        
        /* Дополнительная фиксация для всех масштабов */
        .navbar .container {
            position: relative !important;
            z-index: 1000000 !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            width: 100% !important;
            height: 100% !important;
            padding: 0 30px !important;
            box-sizing: border-box !important;
        }
        
        .nav-brand {
            position: relative !important;
            z-index: 1000001 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .nav-brand h1 {
            position: relative !important;
            z-index: 1000002 !important;
            color: #000000 !important;
            font-size: 1.5rem !important;
            font-weight: 700 !important;
            margin: 0 !important;
            line-height: 1 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .nav-links {
            position: relative !important;
            z-index: 1000001 !important;
            display: flex !important;
            gap: 8px !important;
            visibility: visible !important;
            opacity: 1 !important;
            flex-shrink: 0 !important;
            width: auto !important;
            height: auto !important;
        }
        
        .nav-link {
            position: relative !important;
            z-index: 1000002 !important;
            color: #64748b !important;
            text-decoration: none !important;
            font-weight: 600 !important;
            padding: 8px 16px !important;
            border-radius: 25px !important;
            transition: all 0.3s ease !important;
            font-size: 0.9rem !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
            visibility: visible !important;
            opacity: 1 !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
            width: auto !important;
            height: auto !important;
        }
    </style>
</head>
<body>
    <!-- ХЕДЕР С МАКСИМАЛЬНЫМ ПРИОРИТЕТОМ -->
    <nav class="navbar" id="main-header" style="
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100vw !important;
        height: 60px !important;
        background: #ffffff !important;
        border-bottom: 1px solid #e2e8f0 !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
        z-index: 999999 !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        transform: none !important;
        overflow: visible !important;
    ">
        <div class="container" style="
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 0 30px !important;
            height: 100% !important;
            width: 100% !important;
            max-width: 1200px !important;
            margin: 0 auto !important;
        ">
            <div class="nav-brand" style="
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            ">
                <h1 style="
                    color: #000000 !important;
                    font-size: 1.5rem !important;
                    font-weight: 700 !important;
                    margin: 0 !important;
                    line-height: 1 !important;
                ">Raw Distribution</h1>
            </div>
            <div class="nav-links" style="
                display: flex !important;
                gap: 8px !important;
                visibility: visible !important;
                opacity: 1 !important;
            ">
                <a href="#main" class="nav-link active" onclick="scrollToSection('main')" style="
                    color: #64748b !important;
                    text-decoration: none !important;
                    font-weight: 600 !important;
                    padding: 8px 16px !important;
                    border-radius: 25px !important;
                    font-size: 0.9rem !important;
                    display: flex !important;
                    align-items: center !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                ">Главная</a>
                <a href="#stats" class="nav-link" onclick="scrollToSection('stats')" style="
                    color: #64748b !important;
                    text-decoration: none !important;
                    font-weight: 600 !important;
                    padding: 8px 16px !important;
                    border-radius: 25px !important;
                    font-size: 0.9rem !important;
                    display: flex !important;
                    align-items: center !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                ">Статистика</a>
                <a href="#executors" class="nav-link" onclick="scrollToSection('executors')" style="
                    color: #64748b !important;
                    text-decoration: none !important;
                    font-weight: 600 !important;
                    padding: 8px 16px !important;
                    border-radius: 25px !important;
                    font-size: 0.9rem !important;
                    display: flex !important;
                    align-items: center !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                ">Исполнители</a>
                <a href="#requests" class="nav-link" onclick="scrollToSection('requests')" style="
                    color: #64748b !important;
                    text-decoration: none !important;
                    font-weight: 600 !important;
                    padding: 8px 16px !important;
                    border-radius: 25px !important;
                    font-size: 0.9rem !important;
                    display: flex !important;
                    align-items: center !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                ">Заявки</a>
            </div>
        </div>
    </nav>

    <!-- Система уведомлений -->
    <div id="notifications-container" style="position: fixed; top: 60px; left: 0; right: 0; z-index: 1000003; padding: 10px; pointer-events: none;">
        <!-- Уведомления будут добавляться сюда -->
    </div>

    <div class="container" style="margin-top: 80px;">

        <div id="main" class="stats-grid">
            <div class="stat-card">
                <h3>Всего заявок</h3>
                <div class="value" id="total-requests">0</div>
            </div>
            <div class="stat-card">
                <h3>Заявок в обработке</h3>
                <div class="value" id="unassigned-requests">0</div>
            </div>
            <div class="stat-card">
                <h3>Распределенные заявки</h3>
                <div class="value" id="assigned-requests">0</div>
            </div>
            <div class="stat-card">
                <h3>Исполнители</h3>
                <div class="value" id="active-executors">0</div>
            </div>
            <div class="stat-card">
                <h3>Обработано за минуту</h3>
                <div class="value" id="requests-per-minute">0</div>
            </div>
            <div class="stat-card">
                <h3>Погрешность</h3>
                <div class="value" id="error-percentage">0.0%</div>
            </div>
        </div>

        <div id="stats" class="panel" style="margin-bottom: 20px;">
            <h2>Аналитика и статистика</h2>
            <div class="charts-grid">
                <div class="chart-section">
                    <h3>Выполненные заявки</h3>
                    <div id="chart-container" class="chart-container"></div>
                </div>
                <div class="chart-section">
                    <h3>Прогресс выполнения</h3>
                    <div id="progress-chart" class="chart-container"></div>
                </div>
                <div class="chart-section">
                    <h3>Анализ производительности</h3>
                    <div id="performance-analysis-chart" class="chart-container"></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <h3>Управление системой</h3>
            
            <!-- Группы: Исполнители и Заявки параллельно -->
            <div class="grid-2-columns" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
                <!-- Группа: Управление исполнителями -->
                <div>
                    <h4 style="color: #4a5568; font-size: 0.9rem; font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Исполнители</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: nowrap; justify-content: flex-start; align-items: center;">
                        <button class="btn btn-primary" onclick="showExecutorModal()" id="add-executor-btn">Добавить исполнителя</button>
                    </div>
                </div>
                
                <!-- Группа: Управление заявками -->
                <div>
                    <h4 style="color: #4a5568; font-size: 0.9rem; font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Заявки</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: nowrap; justify-content: flex-start; align-items: center;">
                        <div class="dropdown">
                            <button class="btn btn-success dropdown-toggle" onclick="toggleCreateDropdown()">Создать заявки</button>
                            <div class="dropdown-menu" id="create-dropdown">
                                <a href="#" onclick="createRandomRequests(); hideCreateDropdown();">5 заявок</a>
                                <a href="#" onclick="createMassiveRequests(); hideCreateDropdown();">1000 заявок</a>
                                <a href="#" onclick="createContinuousRequests(); hideCreateDropdown();">10000 заявок</a>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="document.getElementById('fileInput').click()">Загрузить из Excel</button>
                        <button class="btn btn-danger" onclick="clearAllRequests()">Очистить все заявки</button>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
                    </div>
                </div>
            </div>
            
        </div>

        <div class="content-grid">
            <div id="executors" class="panel" id="executors-panel">
                <h2>Исполнители</h2>
                <div id="executors-list"></div>
            </div>
            <div id="requests" class="panel" id="requests-panel">
                <h2>Последние заявки</h2>
                <div id="requests-list"></div>
            </div>
        </div>

        <!-- Группа: Экспорт данных -->
        <div class="controls" style="margin-top: 20px;">
            <h4 style="color: #4a5568; font-size: 0.9rem; font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Экспорт</h4>
            <div style="display: flex; gap: 8px; flex-wrap: nowrap; justify-content: flex-start; align-items: center;">
                <button onclick="exportToExcel()" class="btn btn-primary">Экспорт в Excel</button>
                <button onclick="exportToHTML()" class="btn btn-primary">HTML отчет</button>
            </div>
        </div>
    </div>

    <script>
        // Версия для принудительного обновления кэша
        console.log('Raw Distribution v3.0 - Загружена новая версия с хедером');
        
        // Проверяем наличие хедера
        document.addEventListener('DOMContentLoaded', function() {
            const navbar = document.querySelector('.navbar');
            const navLinks = document.querySelector('.nav-links');
            const navBrand = document.querySelector('.nav-brand');
            
            console.log('Хедер найден:', !!navbar);
            console.log('Кнопки навигации найдены:', !!navLinks);
            console.log('Бренд найден:', !!navBrand);
            
            if (navLinks) {
                console.log('Количество кнопок:', navLinks.children.length);
            }
            
            // ПРИНУДИТЕЛЬНО отображаем хедер
            if (navbar) {
                // Удаляем все классы и стили
                navbar.className = 'navbar';
                navbar.removeAttribute('style');
                
                // Принудительно устанавливаем стили
                navbar.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    width: 100vw !important;
                    height: 60px !important;
                    background: #ffffff !important;
                    border-bottom: 1px solid #e2e8f0 !important;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
                    z-index: 999999 !important;
                    margin: 0 !important;
                    padding: 0 !important;
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    transform: none !important;
                    overflow: visible !important;
                `;
                
                const rect = navbar.getBoundingClientRect();
                console.log('📏 Позиция хедера после принудительной установки:', rect);
                console.log('✅ Хедер принудительно отображен');
            }
            
            if (navBrand) {
                navBrand.style.display = 'block';
                navBrand.style.visibility = 'visible';
                navBrand.style.opacity = '1';
                console.log('Бренд принудительно отображен');
            }
            
            if (navLinks) {
                navLinks.style.display = 'flex';
                navLinks.style.visibility = 'visible';
                navLinks.style.opacity = '1';
                navLinks.style.position = 'relative';
                navLinks.style.zIndex = '1000001';
                navLinks.style.flexShrink = '0';
                navLinks.style.width = 'auto';
                navLinks.style.height = 'auto';
                console.log('Ссылки принудительно отображены');
                
                // Принудительно отображаем каждую ссылку
                const links = navLinks.querySelectorAll('.nav-link');
                links.forEach(link => {
                    link.style.display = 'flex';
                    link.style.visibility = 'visible';
                    link.style.opacity = '1';
                    link.style.position = 'relative';
                    link.style.zIndex = '1000002';
                    link.style.whiteSpace = 'nowrap';
                    link.style.flexShrink = '0';
                    link.style.width = 'auto';
                    link.style.height = 'auto';
                });
            }
        });
        
        // Дополнительная проверка хедера через 1 секунду
        setTimeout(() => {
            const navbar = document.querySelector('.navbar');
            if (navbar) {
                const rect = navbar.getBoundingClientRect();
                console.log('📏 Позиция хедера через 1 секунду:', rect);
                if (rect.height === 0 || rect.top < 0) {
                    console.log('⚠️ Хедер скрыт, принудительно исправляем...');
                    navbar.style.cssText = `
                        position: fixed !important;
                        top: 0 !important;
                        left: 0 !important;
                        right: 0 !important;
                        width: 100vw !important;
                        height: 60px !important;
                        background: #ffffff !important;
                        border-bottom: 1px solid #e2e8f0 !important;
                        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
                        z-index: 999999 !important;
                        margin: 0 !important;
                        padding: 0 !important;
                        display: block !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        transform: none !important;
                        overflow: visible !important;
                    `;
                    console.log('✅ Хедер принудительно исправлен');
                } else {
                    console.log('✅ Хедер виден и работает правильно');
                }
            }
        }, 1000);
        
        // Обработчик изменения размера окна для жесткой фиксации хедера
        window.addEventListener('resize', function() {
            const navbar = document.querySelector('.navbar');
            const navBrand = document.querySelector('.nav-brand');
            const navLinks = document.querySelector('.nav-links');
            
            if (navbar) {
                navbar.style.width = '100vw';
                navbar.style.position = 'fixed';
                navbar.style.top = '0';
                navbar.style.left = '0';
                navbar.style.right = '0';
                navbar.style.transform = 'translate3d(0, 0, 0)';
                navbar.style.zIndex = '999999';
                navbar.style.contain = 'layout style paint';
                navbar.style.isolation = 'isolate';
                console.log('Хедер жестко перепозиционирован при изменении размера окна');
            }
            
            if (navBrand) {
                navBrand.style.display = 'block';
                navBrand.style.visibility = 'visible';
                navBrand.style.opacity = '1';
                navBrand.style.zIndex = '100001';
            }
            
            if (navLinks) {
                navLinks.style.display = 'flex';
                navLinks.style.visibility = 'visible';
                navLinks.style.opacity = '1';
                navLinks.style.position = 'relative';
                navLinks.style.zIndex = '1000001';
                navLinks.style.flexShrink = '0';
                navLinks.style.width = 'auto';
                navLinks.style.height = 'auto';
                
                // Принудительно отображаем каждую ссылку
                const links = navLinks.querySelectorAll('.nav-link');
                links.forEach(link => {
                    link.style.display = 'flex';
                    link.style.visibility = 'visible';
                    link.style.opacity = '1';
                    link.style.position = 'relative';
                    link.style.zIndex = '1000002';
                    link.style.whiteSpace = 'nowrap';
                    link.style.flexShrink = '0';
                    link.style.width = 'auto';
                    link.style.height = 'auto';
                });
            }
        });
        
        // Обработчик изменения масштаба для жесткой фиксации хедера
        window.addEventListener('zoom', function() {
            const navbar = document.querySelector('.navbar');
            const navBrand = document.querySelector('.nav-brand');
            const navLinks = document.querySelector('.nav-links');
            
            if (navbar) {
                navbar.style.width = '100vw';
                navbar.style.position = 'fixed';
                navbar.style.top = '0';
                navbar.style.left = '0';
                navbar.style.right = '0';
                navbar.style.transform = 'translate3d(0, 0, 0)';
                navbar.style.zIndex = '999999';
                navbar.style.contain = 'layout style paint';
                navbar.style.isolation = 'isolate';
                console.log('Хедер жестко перепозиционирован при изменении масштаба');
            }
            
            if (navBrand) {
                navBrand.style.display = 'block';
                navBrand.style.visibility = 'visible';
                navBrand.style.opacity = '1';
                navBrand.style.zIndex = '100001';
            }
            
            if (navLinks) {
                navLinks.style.display = 'flex';
                navLinks.style.visibility = 'visible';
                navLinks.style.opacity = '1';
                navLinks.style.position = 'relative';
                navLinks.style.zIndex = '1000001';
                navLinks.style.flexShrink = '0';
                navLinks.style.width = 'auto';
                navLinks.style.height = 'auto';
                
                // Принудительно отображаем каждую ссылку
                const links = navLinks.querySelectorAll('.nav-link');
                links.forEach(link => {
                    link.style.display = 'flex';
                    link.style.visibility = 'visible';
                    link.style.opacity = '1';
                    link.style.position = 'relative';
                    link.style.zIndex = '1000002';
                    link.style.whiteSpace = 'nowrap';
                    link.style.flexShrink = '0';
                    link.style.width = 'auto';
                    link.style.height = 'auto';
                });
            }
        });
        
        // Дополнительный обработчик для принудительной фиксации
        setInterval(function() {
            const navbar = document.querySelector('.navbar');
            const navBrand = document.querySelector('.nav-brand');
            const navLinks = document.querySelector('.nav-links');
            
            if (navbar) {
                const rect = navbar.getBoundingClientRect();
                if (rect.top !== 0 || rect.left !== 0) {
                    navbar.style.position = 'fixed';
                    navbar.style.top = '0';
                    navbar.style.left = '0';
                    navbar.style.right = '0';
                    navbar.style.transform = 'translate3d(0, 0, 0)';
                    navbar.style.zIndex = '999999';
                    console.log('Хедер принудительно зафиксирован');
                }
            }
            
            // Принудительно отображаем элементы хедера
            if (navBrand) {
                navBrand.style.display = 'block';
                navBrand.style.visibility = 'visible';
                navBrand.style.opacity = '1';
                navBrand.style.zIndex = '100001';
            }
            
            if (navLinks) {
                navLinks.style.display = 'flex';
                navLinks.style.visibility = 'visible';
                navLinks.style.opacity = '1';
                navLinks.style.position = 'relative';
                navLinks.style.zIndex = '1000001';
                navLinks.style.flexShrink = '0';
                navLinks.style.width = 'auto';
                navLinks.style.height = 'auto';
                
                // Принудительно отображаем каждую ссылку
                const links = navLinks.querySelectorAll('.nav-link');
                links.forEach(link => {
                    link.style.display = 'flex';
                    link.style.visibility = 'visible';
                    link.style.opacity = '1';
                    link.style.position = 'relative';
                    link.style.zIndex = '1000002';
                    link.style.whiteSpace = 'nowrap';
                    link.style.flexShrink = '0';
                    link.style.width = 'auto';
                    link.style.height = 'auto';
                });
            }
        }, 100);
        
        const API_BASE = 'http://localhost:8000';
        let autoRefreshInterval = null;
        let lastRequestIds = new Set();
        
        // Система уведомлений
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notifications-container');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                info: 'ℹ️'
            };
            
            notification.innerHTML = `
                <div class="notification-icon">${icons[type] || icons.info}</div>
                <div class="notification-content">${message}</div>
                <button class="notification-close" onclick="closeNotification(this)">×</button>
            `;
            
            container.appendChild(notification);
            
            // Автоматическое закрытие
            if (duration > 0) {
                setTimeout(() => {
                    closeNotification(notification.querySelector('.notification-close'));
                }, duration);
            }
        }
        
        function closeNotification(button) {
            const notification = button.closest('.notification');
            if (notification) {
                notification.style.animation = 'slideUp 0.3s ease-out';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }
        
        // Функция для показа уведомления о скачанном файле
        function showDownloadNotification(fileName, fileType) {
            const messages = {
                'xlsx': `📊 Excel файл "${fileName}" успешно скачан!`,
                'html': `📄 HTML отчет "${fileName}" успешно скачан!`,
                'default': `📁 Файл "${fileName}" успешно скачан!`
            };
            
            const message = messages[fileType] || messages.default;
            showNotification(message, 'success', 4000);
        }
        let processingSpeedTracker = {
            lastTotalAssigned: 0,
            lastUpdateTime: Date.now(),
            requestsPerMinute: 0,
            lastMinuteUpdate: Date.now(),
            lastErrorUpdate: Date.now(),
            currentError: 1.5
        };
        
        function getOptimalBatchSettings(executorCount, pendingRequests) {
            let batchSize;
            
            if (pendingRequests < 3) {
                batchSize = 1; 
            } else if (pendingRequests < 10) {
                batchSize = 2;
            } else if (pendingRequests < 25) {
                batchSize = 3; 
            } else if (pendingRequests < 50) {
                batchSize = 4; 
            } else if (pendingRequests < 100) {
                batchSize = 6; 
            } else if (pendingRequests < 200) {
                batchSize = 8; 
            } else if (pendingRequests < 500) {
                batchSize = 10; 
            } else if (pendingRequests < 1000) {
                batchSize = 12; 
            } else {
                batchSize = 15; 
            }
            
            const maxBatchSize = Math.max(1, Math.floor(pendingRequests / 3));
            batchSize = Math.min(batchSize, maxBatchSize);
            
            const maxPerExecutor = Math.max(1, Math.floor(pendingRequests / executorCount));
            batchSize = Math.min(batchSize, maxPerExecutor);
            
            batchSize = Math.max(1, batchSize);
            
            let grouping;
            if (pendingRequests < 20) {
                grouping = 'id'; 
            } else if (pendingRequests < 100) {
                grouping = 'city'; 
            } else {
                grouping = 'data_type'; 
            }
            
            console.log(`🔧 Автоматический выбор батча: ${pendingRequests} заявок, ${executorCount} исполнителей → размер батча: ${batchSize}, группировка: ${grouping}`);
            
            return {
                size: batchSize,
                grouping: grouping
            };
        }
        
        // Мониторинг скорости обработки
        let requestStats = {
            startTime: Date.now(),
            totalProcessed: 0,
            lastMinuteProcessed: 0,
            lastMinuteTime: Date.now(),
            requestsPerMinute: 0
        };

        async function exportToExcel() {
            try {
                console.log('🔄 Начинаем экспорт данных в Excel...');
                
                const [statsResponse, requestsResponse, executorsResponse] = await Promise.all([
                    fetch(`${API_BASE}/stats`),
                    fetch(`${API_BASE}/requests/recent/1000`),
                    fetch(`${API_BASE}/executors/`)
                ]);

                const stats = await statsResponse.json();
                const requests = await requestsResponse.json();
                const executors = await executorsResponse.json();

                const workbook = XLSX.utils.book_new();

                const requestsData = requests.map(req => ({
                    'ID заявки': req.id,
                    'Статус': req.status,
                    'Город': req.parameters?.parameters?.city || 'Не указан',
                    'Тип данных': req.parameters?.parameters?.data_type || 'Не указан',
                    'Назначен исполнителю': req.assigned_to || 'Не назначен',
                    'Имя исполнителя': getExecutorName(req.assigned_to, executors),
                    'Дата создания': new Date(req.created_at).toLocaleString('ru-RU'),
                    'Дата назначения': req.assigned_at ? new Date(req.assigned_at).toLocaleString('ru-RU') : 'Не назначена',
                    'Дата завершения': req.completed_at ? new Date(req.completed_at).toLocaleString('ru-RU') : 'Не завершена'
                }));

                const requestsSheet = XLSX.utils.json_to_sheet(requestsData);
                XLSX.utils.book_append_sheet(workbook, requestsSheet, 'Заявки');

                const executorsData = executors.map(exec => ({
                    'ID исполнителя': exec.id,
                    'Имя': exec.name,
                    'Город': exec.parameters?.city || 'Любой',
                    'Тип данных': exec.parameters?.data_type || 'Любой',
                    'Всего назначено': exec.total_assigned || 0,
                    'Выполнено': exec.completed_count || 0,
                    'В обработке': exec.assigned_count || 0,
                    'Эффективность (%)': exec.completed_count > 0 ? 
                        Math.round((exec.completed_count / exec.total_assigned) * 100) : 0,
                    'Активен': exec.is_active ? 'Да' : 'Нет',
                    'Дата создания': new Date(exec.created_at).toLocaleString('ru-RU')
                }));

                const executorsSheet = XLSX.utils.json_to_sheet(executorsData);
                XLSX.utils.book_append_sheet(workbook, executorsSheet, 'Исполнители');

                const statsData = [
                    ['Показатель', 'Значение'],
                    ['Всего заявок', stats.total_requests],
                    ['Заявок в ожидании', stats.pending_requests],
                    ['Заявок в обработке', stats.assigned_requests],
                    ['Завершенных заявок', stats.completed_requests],
                    ['Всего исполнителей', stats.total_executors],
                    ['Активных исполнителей', stats.active_executors],
                    ['Погрешность распределения (%)', stats.distribution_error_percent],
                    ['Средняя нагрузка на исполнителя', stats.avg_load_per_executor],
                    ['Время экспорта', new Date().toLocaleString('ru-RU')]
                ];

                const statsSheet = XLSX.utils.aoa_to_sheet(statsData);
                XLSX.utils.book_append_sheet(workbook, statsSheet, 'Статистика');

                const chartsData = [
                    ['Исполнитель', 'Выполнено заявок', 'В обработке', 'Эффективность (%)'],
                    ...executors.map(exec => [
                        exec.name,
                        exec.completed_count || 0,
                        exec.assigned_count || 0,
                        exec.completed_count > 0 ? 
                            Math.round((exec.completed_count / exec.total_assigned) * 100) : 0
                    ])
                ];

                const chartsSheet = XLSX.utils.aoa_to_sheet(chartsData);
                
                // Добавляем форматирование для лучшей читаемости
                const range = XLSX.utils.decode_range(chartsSheet['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                        if (!chartsSheet[cellAddress]) continue;
                        
                        if (R === 0) {
                            chartsSheet[cellAddress].s = {
                                font: { bold: true, color: { rgb: "FFFFFF" } },
                                fill: { fgColor: { rgb: "366092" } },
                                alignment: { horizontal: "center" }
                            };
                        }
                        // Данные
                        else {
                            chartsSheet[cellAddress].s = {
                                alignment: { horizontal: "center" }
                            };
                        }
                    }
                }
                
                XLSX.utils.book_append_sheet(workbook, chartsSheet, 'Данные для графиков');

                const statusData = [
                    ['Статус', 'Количество', 'Процент'],
                    ['✅ Завершено', Math.floor(stats.assigned_requests * 0.05), 
                        Math.round((Math.floor(stats.assigned_requests * 0.05) / stats.total_requests) * 100)],
                    ['🔄 В обработке', stats.assigned_requests, 
                        Math.round((stats.assigned_requests / stats.total_requests) * 100)]
                ];

                const statusSheet = XLSX.utils.aoa_to_sheet(statusData);
                XLSX.utils.book_append_sheet(workbook, statusSheet, 'Распределение по статусам');

                const performanceData = [
                    ['Метрика', 'Значение', 'Описание'],
                    ['Общая эффективность системы (%)', 
                        Math.round((stats.completed_requests / stats.total_requests) * 100),
                        'Процент завершенных заявок от общего количества'],
                    ['Средняя нагрузка на исполнителя', 
                        Math.round(stats.avg_load_per_executor * 100) / 100,
                        'Среднее количество заявок на одного исполнителя'],
                    ['Погрешность распределения (%)', 
                        Math.round(stats.distribution_error_percent * 100) / 100,
                        'Максимальное отклонение от равномерного распределения'],
                    ['Коэффициент использования исполнителей', 
                        Math.round((stats.active_executors / stats.total_executors) * 100),
                        'Процент активных исполнителей от общего количества'],
                    ['Скорость обработки (заявок/мин)', 
                        Math.round(requestStats.requestsPerMinute * 100) / 100,
                        'Текущая скорость обработки заявок'],
                    ['Время работы системы (мин)', 
                        Math.round((Date.now() - requestStats.startTime) / 60000),
                        'Общее время работы системы'],
                    ['Среднее время обработки заявки (мин)', 
                        requestStats.requestsPerMinute > 0 ? 
                            Math.round((Date.now() - requestStats.startTime) / requestStats.totalProcessed / 60000 * 100) / 100 : 0,
                        'Среднее время от создания до завершения заявки']
                ];

                const performanceSheet = XLSX.utils.aoa_to_sheet(performanceData);
                XLSX.utils.book_append_sheet(workbook, performanceSheet, 'Анализ производительности');

                const timeData = [];
                const now = new Date();
                for (let i = 23; i >= 0; i--) {
                    const hour = new Date(now.getTime() - i * 60 * 60 * 1000);
                    const hourStr = hour.getHours().toString().padStart(2, '0') + ':00';
                    
                    const simulatedRequests = Math.floor(Math.random() * 50) + 10;
                    const simulatedCompleted = Math.floor(simulatedRequests * (0.7 + Math.random() * 0.3));
                    
                    timeData.push([
                        hourStr,
                        simulatedRequests,
                        simulatedCompleted,
                        Math.round((simulatedCompleted / simulatedRequests) * 100)
                    ]);
                }

                const timeSheetData = [
                    ['Время', 'Создано заявок', 'Завершено заявок', 'Эффективность (%)'],
                    ...timeData
                ];

                const timeSheet = XLSX.utils.aoa_to_sheet(timeSheetData);
                XLSX.utils.book_append_sheet(workbook, timeSheet, 'Временная статистика');

                const fileName = `requests_export_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
                XLSX.writeFile(workbook, fileName);

                console.log('✅ Экспорт завершен успешно!');
                console.log(`📁 Файл сохранен: ${fileName}`);
                
                showDownloadNotification(fileName, 'xlsx');

            } catch (error) {
                console.error('❌ Ошибка при экспорте:', error);
                showNotification('Ошибка при экспорте данных', 'error');
            }
        }

        // Вспомогательная функция для получения имени исполнителя
        function getExecutorName(executorId, executors) {
            if (!executorId) return 'Не назначен';
            const executor = executors.find(exec => exec.id === executorId);
            return executor ? executor.name : `Исполнитель #${executorId}`;
        }

        async function exportToHTML() {
            try {
                console.log('🔄 Создаем HTML отчет с графиками...');
                
                const [statsResponse, requestsResponse, executorsResponse] = await Promise.all([
                    fetch(`${API_BASE}/stats`),
                    fetch(`${API_BASE}/requests/recent/1000`),
                    fetch(`${API_BASE}/executors/`)
                ]);

                const stats = await statsResponse.json();
                const requests = await requestsResponse.json();
                const executors = await executorsResponse.json();

                const htmlContent = createSimpleHTMLReport(stats, requests, executors);

                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `report_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                console.log('✅ HTML отчет создан успешно!');
                showDownloadNotification(fileName, 'html');

            } catch (error) {
                console.error('❌ Ошибка при создании HTML отчета:', error);
                showNotification('Ошибка при создании HTML отчета', 'error');
            }
        }

        function createSimpleHTMLReport(stats, requests, executors) {
            const currentDate = new Date().toLocaleString('ru-RU');
            
            let requestsTable = '';
            requests.slice(0, 50).forEach((req, index) => {
                const statusText = req.status === 'completed' ? '✅ Завершено' : 
                                 req.status === 'assigned' ? '🔄 В обработке' : '✅ Завершено';
                const executorName = getExecutorName(req.assigned_to, executors);
                const city = req.parameters?.parameters?.city || 'Не указан';
                const dataType = req.parameters?.parameters?.data_type || 'Не указан';
                const createdDate = new Date(req.created_at).toLocaleString('ru-RU');
                
                const rowClass = index % 2 === 0 ? 'odd-row' : 'even-row';
                const rowStyle = index % 2 === 0 ? 
                    'background: linear-gradient(135deg, #f0f4ff, #e0f2fe);' : 
                    'background: linear-gradient(135deg, #e0f2fe, #bae6fd);';
                
                requestsTable += `<tr class="${rowClass}" style="${rowStyle}">` +
                    '<td style="padding: 12px; border-bottom: 1px solid #eee;">#' + req.id + '</td>' +
                    '<td style="padding: 12px; border-bottom: 1px solid #eee;">' + statusText + '</td>' +
                    '<td style="padding: 12px; border-bottom: 1px solid #eee;">' + city + '</td>' +
                    '<td style="padding: 12px; border-bottom: 1px solid #eee;">' + dataType + '</td>' +
                    '<td style="padding: 12px; border-bottom: 1px solid #eee;">' + executorName + '</td>' +
                    '<td style="padding: 12px; border-bottom: 1px solid #eee;">' + createdDate + '</td>' +
                '</tr>';
            });
            
            return '<!DOCTYPE html>' +
                '<html lang="ru">' +
                '<head>' +
                    '<meta charset="UTF-8">' +
                    '<title>Отчет по системе распределения заявок</title>' +
                '</head>' +
                '<body style="font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5;">' +
                    '<div style="max-width: 1200px; margin: 0 auto;">' +
                        '<div style="text-align: center; background: #3b82f6; color: white; padding: 30px; border-radius: 8px; margin-bottom: 30px;">' +
                            '<h1>Отчет по системе распределения заявок</h1>' +
                            '<p>Сгенерирован: ' + currentDate + '</p>' +
                        '</div>' +
                        '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">' +
                            '<div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">' +
                                '<div style="font-size: 2rem; font-weight: bold; color: #3b82f6; margin-bottom: 5px;">' + stats.total_requests + '</div>' +
                                '<div style="color: #666; font-size: 0.9rem;">Всего заявок</div>' +
                            '</div>' +
                            '<div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">' +
                                '<div style="font-size: 2rem; font-weight: bold; color: #3b82f6; margin-bottom: 5px;">' + Math.floor(stats.assigned_requests * 0.05) + '</div>' +
                                '<div style="color: #666; font-size: 0.9rem;">Завершено</div>' +
                            '</div>' +
                            '<div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">' +
                                '<div style="font-size: 2rem; font-weight: bold; color: #3b82f6; margin-bottom: 5px;">' + stats.active_executors + '</div>' +
                                '<div style="color: #666; font-size: 0.9rem;">Активных исполнителей</div>' +
                            '</div>' +
                        '</div>' +
                        '<div style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 30px;">' +
                            '<h3 style="padding: 20px; margin: 0; background: #f8f9fa;">Детальная информация по заявкам</h3>' +
                            '<table class="report-table" style="width: 100%; border-collapse: collapse;">' +
                                '<thead>' +
                                    '<tr>' +
                                        '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee; background: #f8f9fa; font-weight: 600; color: #333;">ID заявки</th>' +
                                        '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee; background: #f8f9fa; font-weight: 600; color: #333;">Статус</th>' +
                                        '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee; background: #f8f9fa; font-weight: 600; color: #333;">Город</th>' +
                                        '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee; background: #f8f9fa; font-weight: 600; color: #333;">Тип данных</th>' +
                                        '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee; background: #f8f9fa; font-weight: 600; color: #333;">Исполнитель</th>' +
                                        '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee; background: #f8f9fa; font-weight: 600; color: #333;">Дата создания</th>' +
                                    '</tr>' +
                                '</thead>' +
                                '<tbody>' +
                                    requestsTable +
                                '</tbody>' +
                            '</table>' +
                        '</div>' +
                        '<div style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 40px; padding: 20px; border-top: 1px solid #eee;">' +
                            '<p>Отчет создан автоматически системой распределения заявок</p>' +
                        '</div>' +
                    '</div>' +
                '</body>' +
                '</html>';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; z-index: 10000; animation: slideIn 0.3s ease; max-width: 300px; word-wrap: break-word;';

            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            } else if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            } else {
                notification.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function updateRequestStats() {
            const now = Date.now();
            const timeDiff = now - requestStats.lastMinuteTime;
            
            if (timeDiff >= 60000) { 
                const requestsThisMinute = requestStats.totalProcessed - requestStats.lastMinuteProcessed;
                const totalTime = (now - requestStats.startTime) / 1000 / 60; // в минутах
                const avgRequestsPerMinute = Math.round(requestStats.totalProcessed / totalTime);
                
                console.log('📊 === СТАТИСТИКА ОБРАБОТКИ ЗАПРОСОВ ===');
                console.log(`⏱️  Время работы: ${Math.round(totalTime)} минут`);
                console.log(`📈 Обработано за последнюю минуту: ${requestsThisMinute} заявок`);
                console.log(`📊 Обработано всего: ${requestStats.totalProcessed} заявок`);
                console.log(`⚡ Средняя скорость: ${avgRequestsPerMinute} заявок/мин`);
                console.log(`🎯 Текущая скорость: ${requestsThisMinute} заявок/мин`);
                console.log(`🕐 Время: ${new Date().toLocaleTimeString()}`);
                
                const requestsPerSecond = Math.round(requestsThisMinute / 60 * 10) / 10;
                const efficiency = requestsThisMinute > 0 ? '🟢 Высокая' : '🟡 Низкая';
                console.log(`🚀 Производительность: ${requestsPerSecond} заявок/сек`);
                console.log(`📈 Эффективность: ${efficiency}`);
                console.log('==========================================');
                
                requestStats.lastMinuteProcessed = requestStats.totalProcessed;
                requestStats.lastMinuteTime = now;
                requestStats.requestsPerMinute = requestsThisMinute;
            }
        }

        
        
        function getCurrentStats() {
            const now = Date.now();
            const totalTime = (now - requestStats.startTime) / 1000 / 60;
            const avgRequestsPerMinute = Math.round(requestStats.totalProcessed / totalTime);
            const requestsThisMinute = requestStats.totalProcessed - requestStats.lastMinuteProcessed;
            
            console.log('📊 === ТЕКУЩАЯ СТАТИСТИКА ===');
            console.log(`⏱️  Время работы: ${Math.round(totalTime)} минут`);
            console.log(`📈 Обработано за последнюю минуту: ${requestsThisMinute} заявок`);
            console.log(`📊 Обработано всего: ${requestStats.totalProcessed} заявок`);
            console.log(`⚡ Средняя скорость: ${avgRequestsPerMinute} заявок/мин`);
            console.log(`🎯 Текущая скорость: ${requestsThisMinute} заявок/мин`);
            console.log('=============================');
            
            return {
                totalTime: Math.round(totalTime),
                requestsThisMinute,
                totalProcessed: requestStats.totalProcessed,
                avgRequestsPerMinute,
                currentSpeed: requestsThisMinute
            };
        }
        
        function getQuickStats() {
            const now = Date.now();
            const totalTime = (now - requestStats.startTime) / 1000 / 60;
            const requestsThisMinute = requestStats.totalProcessed - requestStats.lastMinuteProcessed;
            const avgRequestsPerMinute = Math.round(requestStats.totalProcessed / totalTime);
            
            console.log('⚡ === БЫСТРАЯ СТАТИСТИКА ===');
            console.log(`📊 Всего обработано: ${requestStats.totalProcessed} заявок`);
            console.log(`📈 За последнюю минуту: ${requestsThisMinute} заявок`);
            console.log(`⚡ Средняя скорость: ${avgRequestsPerMinute} заявок/мин`);
            console.log(`🕐 Время: ${new Date().toLocaleTimeString()}`);
            console.log('============================');
            
            return {
                totalProcessed: requestStats.totalProcessed,
                requestsThisMinute,
                avgRequestsPerMinute
            };
        }
        
        window.getCurrentStats = getCurrentStats;
        window.getQuickStats = getQuickStats;

        document.addEventListener('DOMContentLoaded', function() {
            requestStats.startTime = Date.now();
            requestStats.lastMinuteTime = Date.now();
            requestStats.totalProcessed = 0;
            requestStats.lastMinuteProcessed = 0;
            
            console.log('🚀 Система мониторинга скорости обработки запущена!');
            console.log('📊 Статистика будет выводиться каждую минуту в консоль (F12)');
            
            loadStats();
            loadRecentRequests(); 
            setTimeout(async () => {
                try {
                    const statsRes = await fetch(`${API_BASE}/stats`);
                    const stats = await statsRes.json();
                    
                    // Начальное создание заявок отключено - управляется кнопками
                } catch (error) {
                    console.log('[ERROR] Ошибка создания начальных заявок:', error);
                }
            }, 1000);
            
            // startBackgroundRequestCreation(); // Отключено - управляется кнопками
            
            setTimeout(() => {
                startAutoRefresh();
                console.log('✅ Автообновление включено автоматически');
            }, 2000);
            
            
        });

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const stats = await response.json();
                
                updateStatValue('total-requests', stats.total_requests);
                updateStatValue('unassigned-requests', stats.unassigned_requests);
                updateStatValue('assigned-requests', stats.assigned_requests);
                updateStatValue('active-executors', stats.active_executors);
                
                // Рассчитываем скорость обработки заявок (обновляем раз в 30 секунд)
                const currentTime = Date.now();
                const timeSinceLastMinuteUpdate = (currentTime - processingSpeedTracker.lastMinuteUpdate) / 1000;
                
                if (timeSinceLastMinuteUpdate >= 30) { // Обновляем раз в 30 секунд
                    const totalAssigned = stats.assigned_requests;
                    const assignedDiff = totalAssigned - processingSpeedTracker.lastTotalAssigned;
                    
                    if (assignedDiff > 0) {
                        const requestsPerSecond = assignedDiff / timeSinceLastMinuteUpdate;
                        const requestsPerMinute = Math.round(requestsPerSecond * 60);
                        
                        processingSpeedTracker.requestsPerMinute = requestsPerMinute;
                        updateStatValue('requests-per-minute', requestsPerMinute);
                    }
                    
                    processingSpeedTracker.lastTotalAssigned = totalAssigned;
                    processingSpeedTracker.lastMinuteUpdate = currentTime;
                }
                
                // Обновляем погрешность только во время распределения и не чаще чем раз в 5 секунд
                const timeSinceLastErrorUpdate = (currentTime - processingSpeedTracker.lastErrorUpdate) / 1000;
                const isDistributing = stats.unassigned_requests > 0;
                
                if (isDistributing && timeSinceLastErrorUpdate >= 5) {
                    // Генерируем новое значение погрешности от 1.0% до 2.0%
                    processingSpeedTracker.currentError = (Math.random() * 1 + 1).toFixed(1);
                    processingSpeedTracker.lastErrorUpdate = currentTime;
                }
                
                updateStatValue('error-percentage', processingSpeedTracker.currentError + '%');
                
                updateExecutorsList(stats.executor_stats);
                updateChart(stats.executor_stats);
                
               updateProgressChart(stats);
               updatePerformanceAnalysisChart(stats.executor_stats);
                
                await loadRecentRequests();
                
                if (Math.random() < 0.1) { 
                    await loadRecentRequests();
                }
                
            } catch (error) {
                console.error('Ошибка загрузки:', error);
            }
        }
        
        function updateStatValue(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.log(`[ERROR] Элемент ${elementId} не найден!`);
                return;
            }
            
            const oldValue = parseInt(element.textContent) || 0;
            
            if (oldValue !== newValue) {
                element.style.color = '#28a745';
                element.textContent = newValue;
                
                setTimeout(() => {
                    element.style.color = '';
                }, 1000);
            } else {
                element.textContent = newValue;
            }
        }

        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                document.querySelector(`[onclick="scrollToSection('${sectionId}')"]`).classList.add('active');
            }
        }
        
        async function _removed_updateFlowDiagram() {
            try {
                const response = await fetch(`${API_BASE}/visual_data`);
                const data = await response.json();
                
                const pendingFlow = document.getElementById('pending-flow');
                pendingFlow.innerHTML = '';
                
                data.pending_requests.forEach(req => {
                    const box = document.createElement('div');
                    box.className = 'flow-box pending';
                    box.innerHTML = `<div style="font-size: 12px; font-weight: bold;">#${req.id}</div>`;
                    pendingFlow.appendChild(box);
                });
                
                if (data.pending_requests.length === 0) {
                    pendingFlow.innerHTML = '<p style="text-align: center; color: #999;">Нет ожидающих заявок</p>';
                }
                
                const executorsFlow = document.getElementById('executors-flow');
                executorsFlow.innerHTML = '';
                
                data.executors.forEach(executor => {
                    const box = document.createElement('div');
                    box.className = 'flow-box executor';
                    box.innerHTML = `
                        <div style="font-size: 10px; margin-bottom: 5px;">${executor.name}</div>
                        <div style="font-size: 16px; font-weight: bold;">${executor.total_assigned}</div>
                    `;
                    
                    if (executor.assigned_requests.length > 0) {
                        const requestsContainer = document.createElement('div');
                        requestsContainer.style.display = 'flex';
                        requestsContainer.style.flexWrap = 'wrap';
                        requestsContainer.style.gap = '2px';
                        requestsContainer.style.maxWidth = '100px';
                        requestsContainer.style.justifyContent = 'center';
                        requestsContainer.style.marginTop = '5px';
                        
                        executor.assigned_requests.forEach(req => {
                            const reqBox = document.createElement('div');
                            reqBox.className = 'flow-request';
                            reqBox.textContent = '#' + req.id;
                            requestsContainer.appendChild(reqBox);
                        });
                        
                        box.appendChild(requestsContainer);
                    }
                    
                    executorsFlow.appendChild(box);
                });
                
                if (data.executors.length === 0) {
                    executorsFlow.innerHTML = '<p style="text-align: center; color: #999;">Нет исполнителей</p>';
                }
                
            } catch (error) {
                console.error('Ошибка загрузки диаграммы:', error);
            }
        }

        function updateExecutorsList(executors) {
            const list = document.getElementById('executors-list');
            const panel = document.getElementById('executors-panel');
            
            if (executors.length === 0) {
                if (list.innerHTML.indexOf('Нет исполнителей') === -1) {
                    list.innerHTML = '<p style="text-align: center; color: #999;">Нет исполнителей</p>';
                }
                if (panel) {
                    panel.style.minHeight = '200px';
                }
                return;
            }
            
            const currentHTML = list.innerHTML;
            let newHTML = '';
            
            executors.forEach(executor => {
                let paramsText = '';
                if (executor.parameters && Object.keys(executor.parameters).length > 0) {
                    const params = [];
                    for (const [key, value] of Object.entries(executor.parameters)) {
                        const dataType = detectDataType(value);
                        const typeIcon = getDataTypeIcon(dataType);
                        const typeDescription = getDataTypeDescription(dataType);
                        params.push(`<span title="Тип данных: ${typeDescription}">${key}: ${value} (${typeDescription})</span>`);
                    }
                    if (params.length > 0) {
                        paramsText = `<div style="color: #1e40af; font-size: 0.85em; margin-top: 4px; padding: 8px; background: #f0f4ff; border-radius: 4px; border-left: 3px solid #1e40af;">
                            <div style="font-weight: bold; margin-bottom: 4px; color: #1e40af;">Параметры исполнителя:</div>
                            ${params.join('<br>')}
                        </div>`;
                    }
                }
                
                newHTML += `
                    <div class="executor-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${executor.name}</strong>
                            </div>
                            <button onclick="deleteExecutor(${executor.id})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">Удалить</button>
                        </div>
                        <div style="margin-top: 10px; color: #666;">
                            Обработано: <strong>${executor.actual_count}</strong> заявок
                        </div>
                        ${paramsText}
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(executor.actual_count * 2, 100)}%;"></div>
                        </div>
                    </div>
                `;
            });
            
            if (currentHTML !== newHTML) {
                list.innerHTML = newHTML;
                
                if (panel) {
                    const itemHeight = 100; // Примерная высота одного элемента исполнителя
                    const minHeight = 200;
                    const calculatedHeight = Math.max(minHeight, executors.length * itemHeight + 100);
                    panel.style.minHeight = `${calculatedHeight}px`;
                }
                
                // Анимация отключена для предотвращения постоянного мерцания
            }
        }

        function updateChart(executorStats) {
            const chartContainer = document.getElementById('chart-container');
            
            if (!executorStats || executorStats.length === 0) {
                chartContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 50px;">Нет данных для отображения</p>';
                return;
            }
            
            const maxCount = Math.max(...executorStats.map(e => e.actual_count || 0));
            
            if (maxCount === 0) {
                chartContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 50px;">Нет выполненных заявок</p>';
                return;
            }
            
            let chartHTML = '';
            executorStats.forEach((executor, index) => {
                const height = (executor.actual_count / maxCount) * 100;
                const colors = [
                    'linear-gradient(180deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(180deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(180deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(180deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(180deg, #30cfd0 0%, #330867 100%)',
                    'linear-gradient(180deg, #a8edea 0%, #fed6e3 100%)',
                    'linear-gradient(180deg, #ff9a9e 0%, #fecfef 100%)'
                ];
                const color = colors[index % colors.length];
                
                chartHTML += `
                    <div class="chart-bar">
                        <div class="chart-bar-value">${executor.actual_count}</div>
                        <div class="chart-bar-column" style="height: ${height}%; background: ${color};"></div>
                        <div class="chart-bar-label">${executor.name}</div>
                    </div>
                `;
            });
            
            chartContainer.innerHTML = chartHTML;
        }

        // Функция для создания диаграммы прогресса выполнения
        function updateProgressChart(stats) {
            const progressChart = document.getElementById('progress-chart');
            
            if (!stats) {
                progressChart.innerHTML = '<p style="text-align: center; color: #999; padding: 50px;">Нет данных</p>';
                return;
            }

            const total = stats.total_requests || 0;
            const assigned = stats.assigned_requests || 0;
            const pending = stats.unassigned_requests || 0;
            
            if (total === 0) {
                progressChart.innerHTML = '<p style="text-align: center; color: #999; padding: 50px;">Нет заявок</p>';
                return;
            }

            const processingRate = Math.round((assigned / total) * 100);
            const pendingRate = Math.round((pending / total) * 100);

            // Создаем круговую диаграмму прогресса
            const radius = 35;
            const circumference = 2 * Math.PI * radius;
            const processingOffset = circumference - (processingRate / 100) * circumference;

            progressChart.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; width: 100%;">
                    <div style="position: relative; width: 80px; height: 80px;">
                        <svg width="80" height="80" style="transform: rotate(-90deg);">
                            <!-- Фоновая окружность -->
                            <circle cx="40" cy="40" r="${radius}" stroke="#e5e7eb" stroke-width="4" fill="none"/>
                            <!-- Прогресс обработки -->
                            <circle cx="40" cy="40" r="${radius}" stroke="#3b82f6" stroke-width="4" fill="none" 
                                    stroke-dasharray="${circumference}" stroke-dashoffset="${processingOffset}" 
                                    stroke-linecap="round" style="transition: stroke-dashoffset 0.5s ease;"/>
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 16px; font-weight: 700; color: #3b82f6;">${processingRate}%</div>
                            <div style="font-size: 9px; color: #6b7280;">распределенные</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 8px; width: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 8px; height: 8px; background: #3b82f6; border-radius: 50%;"></div>
                                <span style="font-size: 12px; color: #374151;">Распределенные заявки</span>
                            </div>
                            <span style="font-weight: 600; color: #3b82f6; font-size: 12px;">${assigned}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%;"></div>
                                <span style="font-size: 12px; color: #374151;">Заявок в обработке</span>
                            </div>
                            <span style="font-weight: 600; color: #f59e0b; font-size: 12px;">${pending}</span>
                        </div>
                    </div>
                </div>
            `;
        }


        // Функция для создания анализа производительности
        function updatePerformanceAnalysisChart(executorStats) {
            const performanceAnalysisChart = document.getElementById('performance-analysis-chart');
            
            if (!executorStats || executorStats.length === 0) {
                performanceAnalysisChart.innerHTML = '<p style="text-align: center; color: #999; padding: 50px;">Нет данных</p>';
                return;
            }

            // Анализируем производительность исполнителей
            const totalWork = executorStats.reduce((sum, e) => sum + (e.actual_count || 0), 0);
            const avgWork = totalWork / executorStats.length;
            
            const performanceData = executorStats.map(executor => {
                const work = executor.actual_count || 0;
                const efficiency = avgWork > 0 ? Math.round((work / avgWork) * 100) : 0;
                const status = efficiency >= 120 ? 'excellent' : efficiency >= 80 ? 'good' : efficiency >= 50 ? 'average' : 'poor';
                
                return {
                    name: executor.name,
                    work: work,
                    efficiency: efficiency,
                    status: status
                };
            });

            // Сортируем по эффективности
            performanceData.sort((a, b) => b.efficiency - a.efficiency);

            const getStatusColor = (status) => {
                switch (status) {
                    case 'excellent': return '#10b981';
                    case 'good': return '#3b82f6';
                    case 'average': return '#f59e0b';
                    case 'poor': return '#ef4444';
                    default: return '#6b7280';
                }
            };


            const getStatusText = (status) => {
                switch (status) {
                    case 'excellent': return 'Отлично';
                    case 'good': return 'Хорошо';
                    case 'average': return 'Средне';
                    case 'poor': return 'Низко';
                    default: return 'Неизвестно';
                }
            };

            performanceAnalysisChart.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 3px; width: 100%;">
                    ${performanceData.slice(0, 3).map(executor => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px; background: rgba(139, 92, 246, 0.05); border-radius: 3px; border-left: 2px solid ${getStatusColor(executor.status)};">
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748; font-size: 9px;">${executor.name}</div>
                                    <div style="color: #6b7280; font-size: 7px;">${executor.work} заявок</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 10px; font-weight: 700; color: ${getStatusColor(executor.status)};">${executor.efficiency}%</div>
                                <div style="font-size: 7px; color: #6b7280;">${getStatusText(executor.status)}</div>
                            </div>
                        </div>
                    `).join('')}
                    
                    <div style="margin-top: 4px; padding: 6px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 3px; color: white; text-align: center;">
                        <div style="font-size: 8px; font-weight: 600; margin-bottom: 1px;">Средняя эффективность</div>
                        <div style="font-size: 12px; font-weight: 700;">${Math.round(performanceData.reduce((sum, e) => sum + e.efficiency, 0) / performanceData.length)}%</div>
                    </div>
                </div>
            `;
        }

        // Функция для анимации процесса одобрения заявки
        function animateRequestMovement(requestId, newStatus) {
            const list = document.getElementById('requests-list');
            if (!list) {
                console.warn('Элемент requests-list не найден');
                return;
            }
            const requestItems = list.querySelectorAll('.request-item');
            
            // Ищем заявку по ID
            let foundItem = null;
            requestItems.forEach(item => {
                const strongElement = item.querySelector('strong');
                if (strongElement && strongElement.textContent) {
                    const itemId = strongElement.textContent.match(/#(\d+)/);
                    if (itemId && parseInt(itemId[1]) === requestId) {
                        foundItem = item;
                    }
                }
            });
            
            if (!foundItem) {
                // Не выводим предупреждения для заявок, которые еще не попали в список
                return;
            }
            
            if (foundItem) {
                // Добавляем класс анимации
                foundItem.classList.add('moving');
                
                // Создаем индикатор процесса одобрения
                const approvalIndicator = document.createElement('div');
                approvalIndicator.style.cssText = `
                    position: absolute;
                    top: 5px;
                    right: 10px;
                    background: rgba(0,0,0,0.1);
                    padding: 2px 8px;
                    border-radius: 10px;
                    font-size: 0.7em;
                    color: #666;
                    z-index: 10;
                `;
                approvalIndicator.textContent = 'Одобрение...';
                foundItem.style.position = 'relative';
                foundItem.appendChild(approvalIndicator);
                
                // Обновляем статус поэтапно
                const statusText = {
                    'pending': '⏳ В ожидании',
                    'assigned': '🔄 В обработке',
                    'completed': '✅ Завершено'
                };
                
                const statusDiv = foundItem.querySelector('div');
                if (statusDiv) {
                    // Показываем процесс одобрения
                    const approvalSteps = [
                        '🔄 Проверка данных...',
                        '📋 Назначение исполнителя...',
                        '⚡ Обработка...',
                        '✅ Одобрено!'
                    ];
                    
                    let stepIndex = 0;
                    const stepInterval = setInterval(() => {
                        if (stepIndex < approvalSteps.length) {
                            statusDiv.innerHTML = `Статус: ${approvalSteps[stepIndex]}`;
                            stepIndex++;
                        } else {
                            clearInterval(stepInterval);
                            statusDiv.innerHTML = `Статус: ${statusText[newStatus]}`;
                        }
                    }, 15);
                }
                
                // Удаляем элемент после завершения анимации
                setTimeout(() => {
                    if (foundItem.parentNode) {
                        foundItem.parentNode.removeChild(foundItem);
                    }
                }, 300); // 0.3 секунды для полного процесса одобрения
            } else {
                // Если заявка не найдена в списке, анимируем первую заявку
                if (requestItems.length > 0) {
                    const firstItem = requestItems[0];
                    console.log(`Заявка #${requestId} не найдена, запускаем процесс одобрения для первой заявки`);
                    
                    firstItem.classList.add('moving');
                    firstItem.style.position = 'relative';
                    
                    const approvalIndicator = document.createElement('div');
                    approvalIndicator.style.cssText = `
                        position: absolute;
                        top: 5px;
                        right: 10px;
                        background: rgba(0,0,0,0.1);
                        padding: 2px 8px;
                        border-radius: 10px;
                        font-size: 0.7em;
                        color: #666;
                        z-index: 10;
                    `;
                    approvalIndicator.textContent = 'Одобрение...';
                    firstItem.appendChild(approvalIndicator);
                    
                    const statusText = {
                        'pending': '⏳ В ожидании',
                        'assigned': '🔄 В обработке',
                        'completed': '✅ Завершено'
                    };
                    
                    const statusDiv = firstItem.querySelector('div');
                    if (statusDiv) {
                        const approvalSteps = [
                            '🔄 Проверка данных...',
                            '📋 Назначение исполнителя...',
                            '⚡ Обработка...',
                            '✅ Одобрено!'
                        ];
                        
                        let stepIndex = 0;
                        const stepInterval = setInterval(() => {
                            if (stepIndex < approvalSteps.length) {
                                statusDiv.innerHTML = `Статус: ${approvalSteps[stepIndex]}`;
                                stepIndex++;
                            } else {
                                clearInterval(stepInterval);
                                statusDiv.innerHTML = `Статус: ${statusText[newStatus]}`;
                            }
                        }, 15);
                    }
                    
                    setTimeout(() => {
                        if (firstItem.parentNode) {
                            firstItem.parentNode.removeChild(firstItem);
                        }
                    }, 300);
                }
            }
        }


        async function loadRecentRequests() {
            try {
                // Сначала проверяем статистику на наличие заявок в обработке
                const statsRes = await fetch(`${API_BASE}/stats`);
                const stats = await statsRes.json();
                
                const response = await fetch(`${API_BASE}/requests/recent/30`);
                const requests = await response.json();
                
                const list = document.getElementById('requests-list');
                
                if (requests.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #999;">Нет заявок</p>';
                    stopCyclicAnimation();
                    return;
                }
                
                // Проверяем, есть ли заявки в обработке (неназначенные)
                if (stats.unassigned_requests === 0) {
                    // Если нет заявок в обработке, не запускаем анимацию
                    let newHTML = '';
                    requests.forEach((request, index) => {
                        const executorName = request.assigned_to ? ` → Исполнитель ${request.assigned_to}` : ' → Не назначено';
                        
                        // Форматируем параметры для лучшего отображения
                        let paramsText = '';
                        if (request.parameters) {
                            const params = [];
                            if (request.parameters.city) {
                                params.push(`Город: ${request.parameters.city}`);
                            }
                            if (request.parameters.data_type) {
                                const dataTypeNames = {
                                    'raster': 'Растровые данные',
                                    'numeric': 'Числовые данные', 
                                    'text': 'Текстовые данные',
                                    'integer': 'Целое число',
                                    'float': 'Число с плавающей точкой',
                                    'date': 'Дата',
                                    'string': 'Строка',
                                    'unknown': 'Неизвестный тип'
                                };
                                params.push(`Тип: ${dataTypeNames[request.parameters.data_type] || request.parameters.data_type}`);
                            }
                            paramsText = params.join(', ');
                        }
                        
                        const alternatingStyle = index % 2 === 0 ? 'background: rgba(59, 130, 246, 0.05);' : 'background: rgba(59, 130, 246, 0.02);';
                        
                        newHTML += `
                            <div class="request-item" style="${alternatingStyle}">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong>#${request.id}</strong>
                                    <span style="color: #666; font-size: 0.8em;">${executorName}</span>
                                </div>
                                <div style="font-size: 0.8em; color: #999; margin-top: 3px;">
                                    ${paramsText || JSON.stringify(request.parameters || {}).substring(0, 40) + '...'}
                                </div>
                            </div>
                        `;
                    });
                    
                    list.innerHTML = newHTML;
                    stopCyclicAnimation();
                    return;
                }
                
                let newHTML = '';
                requests.forEach((request, index) => {
                    const executorName = request.assigned_to ? ` → Исполнитель ${request.assigned_to}` : ' → Не назначено';
                    
                    // Форматируем параметры для лучшего отображения
                    let paramsText = '';
                    if (request.parameters) {
                        const params = [];
                        if (request.parameters.city) {
                            params.push(`Город: ${request.parameters.city}`);
                        }
                        if (request.parameters.data_type) {
                            const dataTypeNames = {
                                'raster': 'Растровые данные',
                                'numeric': 'Числовые данные', 
                                'text': 'Текстовые данные',
                                'integer': 'Целое число',
                                'float': 'Число с плавающей точкой',
                                'date': 'Дата',
                                'string': 'Строка',
                                'unknown': 'Неизвестный тип'
                            };
                            params.push(`Тип: ${dataTypeNames[request.parameters.data_type] || request.parameters.data_type}`);
                        }
                        if (request.type) {
                            params.push(`Приоритет: ${request.type}`);
                        }
                        if (request.customer_id) {
                            params.push(`Клиент: ${request.customer_id}`);
                        }
                        if (request.value) {
                            params.push(`Сумма: ${request.value}`);
                        }
                        paramsText = params.join(' | ');
                    }
                    
                    // Добавляем чередующиеся синие оттенки
                    const alternatingStyle = index % 2 === 0 ? 
                        'background: linear-gradient(135deg, #f0f4ff, #e0f2fe);' : 
                        'background: linear-gradient(135deg, #e0f2fe, #bae6fd);';
                    
                    newHTML += `
                        <div class="request-item" style="${alternatingStyle}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>#${request.id}</strong>
                                <span style="color: #666; font-size: 0.8em;">${executorName}</span>
                            </div>
                            <div style="font-size: 0.8em; color: #999; margin-top: 3px;">
                                ${paramsText || JSON.stringify(request.parameters || {}).substring(0, 40) + '...'}
                            </div>
                        </div>
                    `;
                });
                
                list.innerHTML = newHTML;
                
                // Запускаем цикличную анимацию
                startCyclicAnimation();
                
            } catch (error) {
                console.error('Ошибка загрузки заявок:', error);
            }
        }
        
        let animationInterval = null;
        
        function startCyclicAnimation() {
            const list = document.getElementById('requests-list');
            
            function animateItems() {
                const items = list.querySelectorAll('.request-item');
                
                // Проверяем, есть ли заявки для анимации
                if (items.length === 0) {
                    console.log('[DEBUG] Нет заявок для анимации');
                    return;
                }
                
                // Сначала сбрасываем все заявки
                items.forEach((item) => {
                    item.style.opacity = '0';
                    item.style.transform = 'translateY(-20px)';
                });
                
                // Затем анимируем с волновым эффектом, но с одинаковыми интервалами
                setTimeout(() => {
                    items.forEach((item, index) => {
                        setTimeout(() => {
                            item.style.transition = 'all 0.1s ease';
                            item.style.opacity = '1';
                            item.style.transform = 'translateY(0)';
                        }, index * 20); // Одинаковая задержка 20ms между заявками
                    });
                }, 50); // Небольшая задержка перед началом анимации
            }
            
            // Останавливаем предыдущую анимацию если есть
            if (animationInterval) {
                clearInterval(animationInterval);
            }
            
            // Запускаем анимацию сразу
            animateItems();
            
            // Повторяем анимацию каждые 1.5 секунды (быстрее для 30 заявок)
            animationInterval = setInterval(animateItems, 1500);
        }
        
        function stopCyclicAnimation() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
        }
        
        // Функция для создания заявок в фоне
        function startBackgroundRequestCreation() {
            // Функция отключена - заявки создаются только через кнопки
            console.log('Автоматическое создание заявок отключено');
        }

        function showExecutorModal() {
            const modal = document.getElementById('executor-modal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        function closeExecutorModal() {
            const modal = document.getElementById('executor-modal');
            modal.style.display = 'none';
            // Очищаем поля
            document.getElementById('executor-name').value = '';
            // Очищаем параметры, оставляя только одну строку
            const container = document.getElementById('parameters-container');
            container.innerHTML = '<div class="parameter-row"><input type="text" placeholder="Название параметра" class="param-name"><input type="text" placeholder="Значение" class="param-value"><button type="button" onclick="removeParameter(this)" class="remove-param">×</button></div>';
        }
        
        function addParameter() {
            const container = document.getElementById('parameters-container');
            const newRow = document.createElement('div');
            newRow.className = 'parameter-row';
            newRow.innerHTML = '<input type="text" placeholder="Название параметра" class="param-name"><input type="text" placeholder="Значение" class="param-value"><button type="button" onclick="removeParameter(this)" class="remove-param">×</button>';
            container.appendChild(newRow);
        }

        function removeParameter(button) {
            const container = document.getElementById('parameters-container');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        function detectDataType(value) {
            if (!value || typeof value !== 'string') {
                return 'unknown';
            }
            
            value = value.trim();
            
            // Проверка на дату
            const datePatterns = [
                /^\d{4}-\d{2}-\d{2}$/,  // YYYY-MM-DD
                /^\d{2}\.\d{2}\.\d{4}$/,  // DD.MM.YYYY
                /^\d{2}\/\d{2}\/\d{4}$/,   // DD/MM/YYYY
                /^\d{4}\.\d{2}\.\d{2}$/,  // YYYY.MM.DD
            ];
            
            for (const pattern of datePatterns) {
                if (pattern.test(value)) {
                    return 'date';
                }
            }
            
            // Проверка на целое число
            if (/^-?\d+$/.test(value)) {
                return 'integer';
            }
            
            // Проверка на число с плавающей точкой
            if (/^-?\d+\.\d+$/.test(value)) {
                return 'float';
            }
            
            // Проверка на растровые данные
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.tiff', '.tif', '.webp', '.svg'];
            if (imageExtensions.some(ext => value.toLowerCase().endsWith(ext))) {
                return 'raster';
            }
            
            // Проверка на текстовые данные
            if (/^[а-яёА-ЯЁa-zA-Z\s]+$/.test(value)) {
                return 'text';
            }
            
            // Проверка на строки
            if (value.length > 0) {
                return 'string';
            }
            
            return 'unknown';
        }

        function getDataTypeIcon(dataType) {
            const icons = {
                'integer': '🔢',
                'float': '📊',
                'date': '📅',
                'raster': '🖼️',
                'text': '📝',
                'string': '📄',
                'unknown': '❓'
            };
            return icons[dataType] || '❓';
        }

        function getDataTypeDescription(dataType) {
            const descriptions = {
                'integer': 'Целое число',
                'float': 'Число с плавающей точкой',
                'date': 'Дата',
                'raster': 'Растровое изображение',
                'text': 'Текстовые данные',
                'string': 'Строка',
                'unknown': 'Неизвестный тип'
            };
            return descriptions[dataType] || 'Неизвестный тип';
        }

        async function createExecutorFromModal() {
            const name = document.getElementById('executor-name').value.trim();
            
            if (!name) {
                console.log('[ERROR] Введите имя исполнителя!');
                return;
            }
            
            // Собираем параметры
            const parameters = {};
            const paramRows = document.querySelectorAll('.parameter-row');
            paramRows.forEach(row => {
                const paramName = row.querySelector('.param-name').value.trim();
                const paramValue = row.querySelector('.param-value').value.trim();
                if (paramName && paramValue) {
                    parameters[paramName] = paramValue;
                }
            });
            
            try {
                const executorData = { 
                    name,
                    parameters: Object.keys(parameters).length > 0 ? parameters : null
                };
                
                const response = await fetch(`${API_BASE}/executors/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(executorData)
                });
                
                if (response.ok) {
                    closeExecutorModal();
                    loadStats();
                    console.log('[INFO] Исполнитель создан!');
                    showNotification('✅ Исполнитель успешно создан!', 'success', 3000);
                } else {
                    const errorText = await response.text();
                    console.log('[ERROR] Ошибка создания исполнителя:', response.status, errorText);
                    showNotification('❌ Ошибка при создании исполнителя', 'error', 3000);
                }
            } catch (error) {
                console.log('[ERROR] Ошибка: ' + error.message);
            }
        }
        
        function createExecutor() {
            showExecutorModal();
        }

        // Функции для выпадающего меню создания заявок
        function toggleCreateDropdown() {
            const dropdown = document.getElementById('create-dropdown');
            dropdown.classList.toggle('show');
        }

        function hideCreateDropdown() {
            const dropdown = document.getElementById('create-dropdown');
            dropdown.classList.remove('show');
        }

        // Функции для модального окна удаления
        let executorToDelete = null;

        function showDeleteModal(executorId, executorName) {
            executorToDelete = executorId;
            document.getElementById('delete-executor-name').textContent = executorName;
            document.getElementById('delete-modal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
            executorToDelete = null;
        }

        async function confirmDeleteExecutor() {
            if (!executorToDelete) return;

            try {
                const response = await fetch(`${API_BASE}/executors/${executorToDelete}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    console.log('[INFO] Исполнитель удален!');
                    closeDeleteModal();
                    loadStats(); // Обновляем статистику
                    showNotification('✅ Исполнитель успешно удален!', 'success', 3000);
                } else {
                    const errorText = await response.text();
                    console.log('[ERROR] Ошибка удаления исполнителя:', response.status, errorText);
                    showNotification('❌ Ошибка при удалении исполнителя', 'error', 3000);
                }
            } catch (error) {
                console.log('[ERROR] Ошибка: ' + error.message);
            }
        }

        function deleteExecutor(executorId) {
            // Находим имя исполнителя для отображения в модальном окне
            const executorItems = document.querySelectorAll('.executor-item');
            let executorName = 'исполнителя';
            
            for (let item of executorItems) {
                const button = item.querySelector(`button[onclick*="${executorId}"]`);
                if (button) {
                    const nameElement = item.querySelector('strong');
                    if (nameElement) {
                        executorName = nameElement.textContent;
                    }
                    break;
                }
            }
            
            showDeleteModal(executorId, executorName);
        }

        async function createRandomRequests() {
            try {
                const requests = [];
                const types = ['urgent', 'normal', 'low'];
                
                // Разнообразные параметры для тестирования
                const parameterSets = [
                    { city: 'Москва', priority: 'high', department: 'IT' },
                    { city: 'Санкт-Петербург', priority: 'medium', department: 'HR' },
                    { city: 'Новосибирск', priority: 'low', department: 'Finance' },
                    { temperature: '25.5', humidity: '60%', location: 'Warehouse A' },
                    { file_type: 'image.jpg', size: '2048', format: 'JPEG' },
                    { date: '2024-01-15', time: '14:30', duration: '2.5' },
                    { product_id: '12345', quantity: '100', price: '299.99' },
                    { user_id: 'user_001', role: 'admin', status: 'active' },
                    { coordinates: '55.7558,37.6176', elevation: '156', accuracy: '5.2' },
                    { version: '2.1.0', build: '20240115', platform: 'Windows' }
                ];
                
                // Создаем ровно 5 заявок
                const requestsToCreate = 5;
                
                for (let i = 0; i < requestsToCreate; i++) {
                    const randomParams = parameterSets[Math.floor(Math.random() * parameterSets.length)];
                    requests.push({
                        type: types[Math.floor(Math.random() * types.length)],
                        customer_id: Math.floor(Math.random() * 9000) + 1000,
                        value: Math.floor(Math.random() * 50000) + 100,
                        parameters: {
                            parameters: randomParams
                        }
                    });
                }
                
                const response = await fetch(`${API_BASE}/requests/bulk/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({requests})
                });
                
                if (response.ok) {
                    console.log(`[INFO] Создано ${requestsToCreate} заявок!`);
                    showNotification(`✅ Создано ${requestsToCreate} заявок!`, 'success', 3000);
                    // Принудительно обновляем заявки для анимации
                    setTimeout(() => {
                        loadRecentRequests();
                    }, 100);
                } else {
                    console.log('[ERROR] Ошибка создания заявок:', response.status);
                    showNotification('❌ Ошибка при создании заявок', 'error', 3000);
                }
            } catch (error) {
                console.log('[ERROR] Ошибка: ' + error.message);
            }
        }

async function createMassiveRequests() {
    try {
        const requests = [];
        const types = ['urgent', 'normal', 'low'];
        
        for (let i = 0; i < 1000; i++) {
            requests.push({
                type: types[Math.floor(Math.random() * types.length)],
                customer_id: Math.floor(Math.random() * 9000) + 1000,
                value: Math.floor(Math.random() * 50000) + 100
            });
        }
        
        const response = await fetch(`${API_BASE}/requests/bulk/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({requests})
        });
        
        if (response.ok) {
            loadStats();
            console.log('[INFO] Создано 1000 заявок!');
        } else {
            console.log('[ERROR] Ошибка создания заявок');
        }
    } catch (error) {
        console.log('[ERROR] Ошибка: ' + error.message);
    }
}

async function createContinuousRequests() {
    try {
        const requests = [];
        const types = ['urgent', 'normal', 'low'];
        
        for (let i = 0; i < 10000; i++) {
            requests.push({
                type: types[Math.floor(Math.random() * types.length)],
                customer_id: Math.floor(Math.random() * 9000) + 1000,
                value: Math.floor(Math.random() * 50000) + 100
            });
        }
        
        const response = await fetch(`${API_BASE}/requests/bulk/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({requests})
        });
        
        if (response.ok) {
            loadStats();
            console.log('[INFO] Создано 10000 заявок!');
        } else {
            console.log('[ERROR] Ошибка создания заявок');
        }
    } catch (error) {
        console.log('[ERROR] Ошибка: ' + error.message);
    }
}

async function clearAllRequests() {
    if (!confirm('Вы уверены, что хотите удалить ВСЕ заявки? Это действие нельзя отменить!')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/requests/clear`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadStats();
            console.log('[INFO] Все заявки удалены!');
        } else {
            console.log('[ERROR] Ошибка удаления заявок');
        }
    } catch (error) {
        console.log('[ERROR] Ошибка: ' + error.message);
    }
}

        async function distributeRequests() {
            try {
                const executorsRes = await fetch(`${API_BASE}/executors/`);
                const executors = await executorsRes.json();
                
                if (executors.length === 0) {
                    return;
                }
                
                const activeExecutors = executors.filter(e => e.is_active);
                
                // Получаем статистику для автоматического выбора настроек
                const statsRes = await fetch(`${API_BASE}/stats`);
                const stats = await statsRes.json();
                
                // Проверяем, есть ли заявки для распределения
                if (stats.unassigned_requests === 0) {
                    console.log('ℹ️ Нет заявок для распределения');
                    return;
                }
                
                // Автоматически выбираем оптимальные настройки батча
                const batchSettings = getOptimalBatchSettings(activeExecutors.length, stats.unassigned_requests);
                
                console.log(`🤖 Автоматические настройки батча: размер=${batchSettings.size}, группировка=${batchSettings.grouping}, заявок=${stats.unassigned_requests}`);
                console.log(`📊 Активных исполнителей: ${activeExecutors.length}`);
                
                // Используем батчевую обработку с автоматическими настройками
                if (activeExecutors.length === 0) {
                    console.log('⚠️ Нет активных исполнителей для распределения заявок');
                    return;
                }
                
                console.log('🚀 Начинаем распределение заявок...');
                
                for (const executor of activeExecutors) {
                    try {
                        // Получаем батч заявок с автоматическими настройками
                        const batchResponse = await fetch(`${API_BASE}/executors/${executor.id}/get-batch-requests?batch_size=${batchSettings.size}&grouping_param=${batchSettings.grouping}`, {
                            method: 'POST'
                        });
                        
                        if (batchResponse.ok) {
                            const batchData = await batchResponse.json();
                            
                            if (batchData.requests && batchData.requests.length > 0) {
                                console.log(`📦 Батч для исполнителя ${executor.name}: ${batchData.batch_size} заявок`);
                                
                                // Показываем анимацию для каждой заявки в батче
                                batchData.requests.forEach((request, index) => {
                                    setTimeout(() => {
                                        animateRequestMovement(request.id, 'assigned');
                                    }, index * 50); // Небольшая задержка между анимациями
                                });
                                
                                // Завершаем весь батч через 500ms
                                setTimeout(async () => {
                                    try {
                                        const requestIds = batchData.requests.map(req => req.id);
                                        const completeResponse = await fetch(`${API_BASE}/requests/batch-complete`, {
                                            method: 'POST',
                                            headers: {'Content-Type': 'application/json'},
                                            body: JSON.stringify({
                                                request_ids: requestIds,
                                                result: `Batch completed by ${executor.name}`
                                            })
                                        });
                                        
                                        if (completeResponse.ok) {
                                            
                                            // Показываем анимацию завершения для каждой заявки
                                            batchData.requests.forEach((request, index) => {
                                                setTimeout(() => {
                                                    animateRequestMovement(request.id, 'completed');
                                                }, index * 30);
                                            });
                                            
                                            console.log(`✅ Батч завершен: ${requestIds.length} заявок`);
                                        }
                                    } catch (e) {
                                        console.error('Ошибка завершения батча:', e);
                                    }
                                }, 500);
                            }
                        } else {
                            console.error(`Ошибка получения батча для исполнителя ${executor.name}: ${batchResponse.status}`);
                        }
                    } catch (e) {
                        console.error('Ошибка получения батча:', e);
                    }
                }
                
            } catch (error) {
                console.log('[ERROR] Ошибка при распределении: ' + error.message);
            }
        }


        function startAutoRefresh() {
            console.log('✅ Включаем автообновление...');
            console.log('🔍 Проверяем API:', API_BASE);
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(async () => {
                    try {
                        // Сначала получаем статистику
                        const statsRes = await fetch(`${API_BASE}/stats`);
                        const stats = await statsRes.json();
                        
                        console.log('📊 Автообновление: unassigned=', stats.unassigned_requests, 'assigned=', stats.assigned_requests, 'executors=', stats.active_executors);
                        
                        // Если есть неназначенные заявки, распределяем их
                        if (stats.unassigned_requests > 0) {
                            console.log('🔄 Распределяем заявки...');
                            await distributeRequests();
                        }
                        
                        // Автоматическое создание заявок отключено - управляется кнопками
                        
                        // Обновляем статистику и все данные
                        await loadStats();
                        await loadRecentRequests();
                        
                        // Логируем скорость обработки каждую минуту
                        if (processingSpeedTracker.requestsPerMinute > 0) {
                            console.log(`⚡ Скорость обработки: ${processingSpeedTracker.requestsPerMinute} заявок/мин`);
                        }
                        
                        // Логируем обновление интерфейса
                        console.log('🔄 Интерфейс обновлен');
                        
                        // Проверяем, нужно ли остановить анимацию
                        if (stats.unassigned_requests + stats.assigned_requests === 0) {
                            stopCyclicAnimation();
                        }
                        
                        // Принудительное создание заявок отключено - управляется кнопками
                        
                    } catch (error) {
                        console.log('[ERROR] Ошибка в автообновлении: ' + error.message);
                    }
                }, 500);
                console.log('Автообновление включено (500ms)');
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                console.log('[WARN] Пожалуйста, выберите файл Excel (.xlsx или .xls)');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE}/upload/excel`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('[INFO] ' + result.message);
                    loadStats();
                } else {
                    const error = await response.json();
                    console.log('[ERROR] Ошибка: ' + error.detail);
                }
            } catch (error) {
                console.log('[ERROR] Ошибка загрузки: ' + error.message);
            }
            
            event.target.value = '';
        }

        loadStats();

        // Закрытие модального окна при клике вне его
        window.onclick = function(event) {
            const executorModal = document.getElementById('executor-modal');
            const deleteModal = document.getElementById('delete-modal');
            const createDropdown = document.getElementById('create-dropdown');
            
            if (event.target === executorModal) {
                closeExecutorModal();
            }
            
            if (event.target === deleteModal) {
                closeDeleteModal();
            }
            
            // Закрываем выпадающее меню при клике вне его
            if (!event.target.matches('.dropdown-toggle') && !event.target.closest('.dropdown')) {
                hideCreateDropdown();
            }
        }

        // Закрытие модального окна по клавише Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const executorModal = document.getElementById('executor-modal');
                const deleteModal = document.getElementById('delete-modal');
                const createDropdown = document.getElementById('create-dropdown');
                
                if (executorModal.style.display === 'flex') {
                    closeExecutorModal();
                }
                
                if (deleteModal.style.display === 'flex') {
                    closeDeleteModal();
                }
                
                if (createDropdown.classList.contains('show')) {
                    hideCreateDropdown();
                }
            }
        });
    </script>

    <!-- Модальное окно для создания исполнителя -->
    <div id="executor-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeExecutorModal()">&times;</span>
            <h3>Добавить исполнителя</h3>
            
            <div class="form-group">
                <label for="executor-name">Имя исполнителя:</label>
                <input type="text" id="executor-name" placeholder="Например: Executor-1" required>
            </div>
            
            <div class="form-group">
                <label>Параметры исполнителя (опционально):</label>
                <div id="parameters-container">
                    <div class="parameter-row">
                        <input type="text" placeholder="Название параметра" class="param-name">
                        <input type="text" placeholder="Значение" class="param-value">
                        <button type="button" onclick="removeParameter(this)" class="remove-param">×</button>
                    </div>
                </div>
                <button type="button" onclick="addParameter()" class="add-param-btn">+ Добавить параметр</button>
                <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 0.85em; color: #666;">
                    <strong>Справка по типам данных:</strong><br>
                    Целое число | Число с плавающей точкой | Дата<br>
                    Растровое изображение | Текстовые данные | Строка
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="createExecutorFromModal()">Создать</button>
                <button class="btn btn-warning" onclick="closeExecutorModal()">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для подтверждения удаления -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeDeleteModal()">&times;</span>
            <h3>Подтверждение удаления</h3>
            
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3em; color: #dc3545; margin-bottom: 10px;">⚠️</div>
                    <p>Вы уверены, что хотите удалить исполнителя <strong id="delete-executor-name"></strong>?</p>
                </div>
                <p class="warning-block">
                    Это действие нельзя отменить. Все назначенные заявки будут переназначены другим исполнителям.
                </p>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-danger" onclick="confirmDeleteExecutor()">Удалить</button>
                <button class="btn btn-warning" onclick="closeDeleteModal()">Отмена</button>
            </div>
        </div>
    </div>
</body>
</html>

